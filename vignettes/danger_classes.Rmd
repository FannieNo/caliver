---
title: "Verification of danger classes"
author: "Claudia Vitolo"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: references.bib
vignette: >
  %\VignetteIndexEntry{caliver}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!--
# Copyright 2016 European Centre for Medium-Range Weather Forecasts (ECMWF)
# This software is licensed under the terms of the Apache Licence Version 2.0 
# which can be obtained at http://www.apache.org/licenses/LICENSE-2.0. 
# In applying this licence, ECMWF does not waive the privileges and immunities 
# granted to it by virtue of its status as an intergovernmental organisation nor
# does it submit to any jurisdiction.
-->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE,
                      eval = FALSE)
```

The package caliver contains functions for the calibration and verification of gridded model outputs. The package was designed with a fire risk model in mind (GEFF) but, in the near future, this is going to develop in a model agnostic tool. The introductory vignette "An introduction to the caliver package" explains in details the main functionalities of this package. The goal of this vignette, instead, is to describe how to use caliver to calculate and verify fire danger classes based on user-defined areas. This vignette contains the code to run all the analyses in [@digiuseppe:2017], please refer to this paper for more information on the methodology.

## R package caliver

For information on how to install and load caliver, please refer to the vignette "An introduction to the caliver package" and the README file in the repository.

```{r, eval = FALSE}
# Install caliver from GitHub
install.packages("devtools")
devtools::install_github("ecmwf/caliver")
```

```{r, eval = TRUE}
library("caliver")
library("raster")
library("ggplot2")
```

## Get data

#### Reanalysis data

For a matter of consistency with the introductory vignette, we will use the FWI as index to estimate the fire danger classes. The first step is to download (from the [GEFF-reanalysis web app](http://apps.ecmwf.int/datasets/data/geff-reanalysis/)) reanalysis data from 1980 to 2016. Assuming that data is downloaded in the folder 'reanalysis' of the working directory, we can use catNetcdf to aggregate all the files into one netcdf file (this is not necessary if you have run through the examples in the intro vignette) and load it as RasterBrick.

```{r, eval = TRUE}
# FWI reanalysis dataset
# catNetcdf(inDir = 'reanalysis', outFileName = 'FWIr_1980-2016.nc')
FWI <- raster::brick("/scratch/mo/moc0/fire/FWIr_1980-2016.nc")

# Define a vector with a sequence of dates related to the reanalysis
dataDates <- seq.Date(from = as.Date("1980-01-01"), to = as.Date("2016-12-31"),
                      by = "day")
```

#### GFED4 areas and countries of interest 

We will demonstrate how to calculate and validate fire danger levels for 4 GFED4 areas and countries: 

- Boreal North America (BONA) and Canada,
- Europe (EURO) and Spain,
- Equatorial Asia (EQAS) and Indonesia,
- Southern Hemisphere South America (SHSA) and Chile.

```{r, eval = FALSE}
# GFED4 regions of interest
BONA <- getGFED4(varname = "BasisRegions", region = "BONA")
EURO <- getGFED4(varname = "BasisRegions", region = "EURO")
EQAS <- getGFED4(varname = "BasisRegions", region = "EQAS")
SHSA <- getGFED4(varname = "BasisRegions", region = "SHSA")
```

```{r, eval = TRUE}
# Countries of interest (GADM administrative boundaries)
Spain     <- raster::getData(name = "GADM", country = "Spain", level = 0)
Canada    <- raster::getData(name = "GADM", country = "Canada", level = 0)
Indonesia <- raster::getData(name = "GADM", country = "Indonesia", level = 0)
Chile     <- raster::getData(name = "GADM", country = "Chile", level = 0)
```

Plot areas and countries of interest (Fig.1).

```{r, eval = FALSE}
rtp <- BONA
rtp@data$id <- 1:nrow(rtp@data)   # add id column for join
rtpFort <- fortify(rtp, data = rtp@data)
rtpFortMer1 <- merge(rtpFort, rtp@data, by.x = "id", by.y = "id")  # join data
rtpFortMer1$Region <- "BONA"

rtp <- EURO
rtp@data$id <- 1:nrow(rtp@data)   # add id column for join
rtpFort <- fortify(rtp, data = rtp@data)
rtpFortMer2 <- merge(rtpFort, rtp@data, by.x = "id", by.y = "id")  # join data
rtpFortMer2$Region <- "EURO"

rtp <-EQAS
rtp@data$id <- 1:nrow(rtp@data)   # add id column for join
rtpFort <- fortify(rtp, data = rtp@data)
rtpFortMer3 <- merge(rtpFort, rtp@data, by.x = "id", by.y = "id")  # join data
rtpFortMer3$Region <- "EQAS"

rtp <- SHSA
rtp@data$id <- 1:nrow(rtp@data)   # add id column for join
rtpFort <- fortify(rtp, data = rtp@data)
rtpFortMer4 <- merge(rtpFort, rtp@data, by.x = "id", by.y = "id")  # join data
rtpFortMer4$Region <- "SHSA"

# Plot worldmap using data from worldmap and colour selected countries
world <- ggplot(aes(x = long, y = lat), data = map_data("world")) +
  geom_polygon(aes(group = group), fill=NA, colour = "grey65") +
  coord_equal() +  theme_bw() + xlab("Longitude") + ylab("Latitude") +
  geom_polygon(data = rtpFortMer1,
               aes(x = long, y = lat, group = group, fill = Region),
               alpha = 0.5) +
  geom_polygon(data = rtpFortMer2,
               aes(x = long, y = lat, group = group, fill = Region),
               alpha = 0.5) +
  geom_polygon(data = rtpFortMer3,
               aes(x = long, y = lat, group = group, fill = Region),
               alpha = 0.5) +
  geom_polygon(data = rtpFortMer4,
               aes(x = long, y = lat, group = group, fill = Region),
               alpha = 0.5) +
  scale_fill_manual(name="GFED4 regions",
                    values = c("#B3CDE3", "#FED9A6", "#FDDAEC", "#d8f2cd"),
                    labels = c("BONA", "EQAS", "EURO", "SHSA"))

cols <- c("Canada" = "#377EB8", "Spain" = "#F781BF", 
          "Indonesia" = "#FF7F00", "Chile" = "#75BC36")
worldcountries <- world + 
  geom_polygon(data = map_data("world", region = "Canada"),
               aes(x = long, y = lat, group = group, colour = "Canada"), 
               fill = NA) +
  geom_polygon(data = map_data("world", region = "Spain"),
               aes(x = long, y = lat, group = group, colour = "Spain"), 
               fill = NA) +
  geom_polygon(data = map_data("world", region = "Indonesia"),
               aes(x = long, y = lat, group = group, colour = "Indonesia"), 
               fill = NA) +
  geom_polygon(data = map_data("world", region = "Chile"),
               aes(x = long, y = lat, group = group, colour = "Chile"), 
               fill = NA) +
  scale_colour_manual(name = "Countries", values = cols)

# ggsave(file="Fig1.eps", plot= worldcountries, 
#        device = cairo_ps, fallback_resolution = 600, 
#        width=unit(8, "in"), height=unit(5, "in"))
```

## Calculate fire danger classes by GFED4 areas and countries

Define fire seasons for the three cases: north and south hemispheres, and tropics.

```{r, eval = TRUE}
# Extract fire seasons for the northern emisphere
seasonsN <- getFireSeason(DATES = dataDates, zone = "north")
# Create Fire Season Indices (FSI)
northFSI <- which(seasonsN == TRUE)

# Extract fire seasons for the southern emisphere
seasonsS <- getFireSeason(DATES = dataDates, zone = "south")
# Create Fire Season Indices (FSI)
southFSI <- which(seasonsS == TRUE)

# Extract fire seasons for the tropics
seasonsT <- getFireSeason(DATES = dataDates, zone = "tropics")
# Create Fire Season Indices (FSI)
tropicFSI <- which(seasonsT == TRUE)
```

Calculate fire danger classes as shown in the introductory vignette.

```{r}
# Initialise empty matrix to store thresholds
df <- matrix(data = NA, nrow = 0, ncol = 7)

# Mask/Crop/Subset FWI and generate thresholds for BONA & Canada ###############
region <- BONA
regionR <- maskcropsub(r = FWI, p = region, mask = T, crop = T,
                       i2subset = northFSI)
df <- rbind(df, c("BONA", 0, FireDangerLevels(fireIndex = regionR)))

country <- Canada
countryFWI <- maskcropsub(r = FWI, p = country, mask = T, crop = T,
                        i2subset = northFSI)
df <- rbind(df, c(country$NAME_ENGLISH, 0, 
                  FireDangerLevels(fireIndex = countryFWI)))

percs <- round(quantile(na.omit(as.vector(countryFWI)), 
                        probs = c(0.70, 0.90, 0.98)), 0)

# Density plot with thresholds
countryPDF <- plotPDF(fireIndex = countryFWI, 
                      countryName = country$NAME_ENGLISH, 
                      thresholds = as.numeric(df[which(df[,1]== 
                                                         country$NAME_ENGLISH),
                                                 3:7]),
                      upperLimit = 105, 
                      vLines = percs)

# ggsave(file = paste0(country$NAME_ENGLISH, "PDF.eps"),
#        plot = countryPDF, width=unit(8, "in"), height=unit(5, "in"))

# Mask/Crop/Subset FWI and generate thresholds for EURO/Spain ##################
region <- EURO
regionR <- maskcropsub(r = FWI, p = region, mask = T, crop = T,
                       i2subset = northFSI)
df <- rbind(df, c("EURO", 0, FireDangerLevels(fireIndex = regionR)))

country <- Spain
countryFWI <- maskcropsub(r = FWI, p = country, mask = T, crop = T,
                          i2subset = northFSI)
df <- rbind(df, c(country$NAME_ENGLISH, 0,
                  FireDangerLevels(fireIndex = countryFWI)))

percs <- round(quantile(na.omit(as.vector(countryFWI)), 
                        probs = c(0.70, 0.90, 0.98)), 0)

# Density plot with thresholds
countryPDF <- plotPDF(fireIndex = countryFWI, 
                      countryName = country$NAME_ENGLISH, 
                      thresholds = as.numeric(df[which(df[,1]== 
                                                         country$NAME_ENGLISH),
                                                 3:7]),
                      upperLimit = 105, 
                      vLines = percs)

# ggsave(file = paste0(country$NAME_ENGLISH, "PDF.eps"),
#        plot = countryPDF, width=unit(8, "in"), height=unit(5, "in"))

# Mask/Crop/Subset FWI and generate thresholds for EQAS/Indonesia ##############
region <- EQAS
regionR <- maskcropsub(r = FWI, p = region, mask = T, crop = T,
                       i2subset = tropicFSI)
df <- rbind(df, c("EQAS", 0, FireDangerLevels(fireIndex = regionR)))

country <- Indonesia
countryFWI <- maskcropsub(r = FWI, p = country, mask = T, crop = T,
                          i2subset = tropicFSI)
df <- rbind(df, c(country$NAME_ENGLISH, 0,
                  FireDangerLevels(fireIndex = countryFWI)))

percs <- round(quantile(na.omit(as.vector(countryFWI)), 
                        probs = c(0.70, 0.90, 0.98)), 0)

# Density plot with thresholds
countryPDF <- plotPDF(fireIndex = countryFWI, 
                      countryName = country$NAME_ENGLISH, 
                      thresholds = as.numeric(df[which(df[,1]== 
                                                         country$NAME_ENGLISH),
                                                 3:7]),
                      upperLimit = 105, 
                      vLines = percs)

# ggsave(file = paste0(country$NAME_ENGLISH, "PDF.eps"),
#        plot = countryPDF, width=unit(8, "in"), height=unit(5, "in"))

# Mask/Crop/Subset FWI and generate thresholds for SHSA/Chile ##################
region <- SHSA
regionR <- maskcropsub(r = FWI, p = region, mask = T, crop = T, 
                       i2subset = southFSI)
df <- rbind(df, c("SHSA", 0, FireDangerLevels(fireIndex = regionR)))

country <- Chile
countryFWI <- maskcropsub(r = FWI, p = country, mask = T, crop = T,
                        i2subset = southFSI)
df <- rbind(df, c(country$NAME_ENGLISH, 0,
                  FireDangerLevels(fireIndex = countryFWI)))
saveRDS(df, "thresholds.rds")

percs <- round(quantile(na.omit(as.vector(countryFWI)), 
                        probs = c(0.70, 0.90, 0.98)), 0)

# Density plot with thresholds
countryPDF <- plotPDF(fireIndex = countryFWI, 
                      countryName = country$NAME_ENGLISH, 
                      thresholds = as.numeric(df[which(df[,1]== 
                                                         country$NAME_ENGLISH),
                                                 3:7]),
                      upperLimit = 105, 
                      vLines = percs)

# ggsave(file = paste0(country$NAME_ENGLISH, "PDF.eps"),
#        plot = countryPDF, width=unit(8, "in"), height=unit(5, "in"))

# Convert matrix to data frame, assign column names and save
df2 <- data.frame(df, stringsAsFactors = FALSE)
names(df) <- c("Area", "VeryLow", "Low", "Moderate", 
               "High", "VeryHigh", "Extreme")
saveRDS(df, "thresholds.rds")
```

```{r, eval = TRUE, echo = FALSE}
df <- readRDS("/scratch/mo/moc0/fire/thresholds.rds")

knitr::kable(df[1:8,], row.names = FALSE)
```

## Verify fire danger classes

The following four events were selected to verify the previously calculated danger classes:

  * Indonesia	2015-09-10	2015-09-24	
  * Canada	2016-05-01	2016-05-15 (Alberta's region)
  * Spain	2016-08-28	2016-09-11	 
  * Chile	2017-01-15	2017-01-29
  
In order to find the actual area affected by fires (for each of the above events), we follow the steps below:

  1. Get Fire Radiative Power from CAMS observations using the bash script [CAMS_GFAS_Observations.sh](https://software.ecmwf.int/stash/projects/CEMSF/repos/fire_utilities/browse/sh/CAMS_GFAS_Observations.sh):
     `sh CAMS_Observations.sh`. This generates the file: CAMS_**TimeWindow**_frpfire_rotated.nc
  2. Load the file above as RasterBrick
  3. Sum all the FRP over time
  4. If there are many small fires, we can set a threshold of minimum radiative power to be considered. Convert layer info to binary: 1 if FRP > 0.5, 0 otherwise
  5. Plot to check maximum extension
  6. Remove zeros and create a bounding box (fireBBOX) including only cells = 1
  
Once the affected area has been identified, we use this to verify the forecast with the observed fire radiative power.

Forecast data is obtained by using the bash scripts: [GEFF_Forecast.sh](https://software.ecmwf.int/stash/projects/CEMSF/repos/fire_utilities/browse/sh/GEFF_Forecast.sh): `sh GEFF_Forecast.sh`. This generates one file per forecast day: **StartDate**_**EndDate**_ecfire_fwi_fwi.nc

The code below shows how to perform the verification for the 4 events. 
  
#### Canada

Numerous wildfire in the Alberta region (Canada) were reported in May 2016. 

```{r, eval = TRUE}
Alberta <- raster::getData(name = "GADM", 
                           country = "Canada", 
                           level = 1)
Alberta <- Alberta[which(Alberta$NAME_1 == "Alberta"),]
```

```{r, eval = FALSE}
subRegion <- Alberta
subRegionFWI <- maskcropsub(r = FWI, p = subRegion, mask = T, crop = T,
                            i2subset = northFSI)
df <- as.matrix(df)
df <- rbind(df, c(subRegion$NAME_1, 0, FireDangerLevels(fireIndex = subRegionFWI)))
df <- data.frame(df, stringsAsFactors = FALSE)
# saveRDS(df, "thresholds.rds")
```

In the table below we compare the danger levels at large scale, national and regional level.

```{r, eval = TRUE, echo = FALSE}
knitr::kable(df[c(1,2,9),], row.names = FALSE)
```

```{r, eval = TRUE, fig.height=10, fig.width=10}
# 2. Load the frp file as RasterBrick:
startDate <- "2016-05-01"
endDate <- "2016-05-31"
x <- raster::brick(paste0("/scratch/mo/moc0/fire/events/CAMS_",
                          startDate, "_", endDate, "_frpfire_rotated.nc"))

# 3. Sum all the FRP over time
xsum <- raster::calc(x, sum)

# 4. Convert layer info to binary: 1 if FRP > 0.5, 0 otherwise
xsum[xsum > 0.5] <- 1
xsum[xsum <= 0.5] <- 0
raster::plot(maskcropsub(r = xsum, p = Canada, mask = TRUE, crop = TRUE))
raster::plot(Alberta, add = TRUE)

# 5-6. Remove zeros and create a bounding box including only cells = 1
xsum[xsum == 0] <- NA
fireBBOX <- as(raster::extent(raster::trim(maskcropsub(r = xsum, 
                                                       p = Alberta, 
                                                       mask = TRUE, 
                                                       crop = TRUE))), 
               'SpatialPolygons')
raster::plot(fireBBOX, border = "red", add = TRUE)
```

In the figure above Canada is shaded in gray, Alberta is identified by the black polygon while the areas in green show the most important fire activities. If we focus on the Alberta region, the most important fire activities are enclosed in the red polygon (called fireBBOX hereafter). 

At this point we compare the fire activities in the fireBBOX with the high danger level calculated previously for Canada.

```{r, eval = TRUE, fig.height=10, fig.width=10}
# Choose the area of interest
areaOfInterest <- fireBBOX # It could be: fireBBOX, Alberta, Canada, BONA

# Modify script to get forecasts /home/mo/moc0/Repositories/fire_utilities/sh/GEFF_Forecast.sh
# Download forecasted FWI
# sh /home/mo/moc0/Repositories/fire_utilities/sh/GEFF_Forecast.sh
# Set forecast and observation dates
ForecastDates <- ObservationDates <- seq.Date(from = as.Date(startDate), 
                                              to = as.Date(endDate),
                                              by = "day")

thresholds <- c(as.numeric(as.character(as.matrix(df[df$Area ==
                                                       "Canada",2:7]))), 100)

# Initialise the matrix to hold the values
rastMean <- matrix(NA, 
                   nrow = length(ObservationDates), 
                   ncol = length(ForecastDates))

# For each starting date and forecast date, calculate average the percentage of
# pixels exceeding the high danger level
for (i in 1:length(ObservationDates)){
  
  # transform dates to strings to build file name
  startD <- gsub("-", "", as.character(ObservationDates[i]))
  
  for (j in 1:length(ForecastDates)){
    
    # transform dates to strings to build file name
    endD <- gsub("-", "", as.character(ForecastDates[j]))
    
    file2read <- paste0("/scratch/mo/moc0/fire/GEFF1.2/forecast_fwi/", 
                        startD, "_", endD, "_ecfire_fwi_fwi.nc")
    
    if (file.exists(file2read)){
      
      rasterMap <- raster::raster(file2read)
      if (round(rasterMap@extent@xmin,0) == 0) rasterMap <- raster::rotate(rasterMap)
      rM <- raster::crop(rasterMap, areaOfInterest)
      nTotal <- dim(rM)[1]*dim(rM)[2]
      perc <- length(rM[rM >= thresholds[4]])/nTotal
      rastMean[i,j] <- perc
      
    }
    
  }
  
}
x <- reshape2::melt(rastMean*100)

# Get FRP
rangeIDX <- 1:length(ForecastDates)
frp <- raster::brick(paste0("/scratch/mo/moc0/fire/events/CAMS_", ObservationDates[1],
                            "_", ObservationDates[length(ObservationDates)],
                            "_frpfire_rotated.nc"))
frpCROPPED <- maskcropsub(r = frp, p = areaOfInterest, 
                          mask = TRUE, crop = FALSE, i2subset = rangeIDX)
frpTS <- as.numeric(raster::cellStats(frpCROPPED, sum))
dfFRP <- data.frame(date = ForecastDates, 
                    frp = plotrix::rescale(frpTS, c(0, length(rangeIDX))))

# Make the boxy forecast plot using ggplot2
ggplot(x, aes(Var1, Var2)) + 
  geom_tile(aes(fill = value), colour = "white") + 
  scale_fill_distiller(palette = "Spectral", na.value = NA,
                       name = "% of pixels\nexceeding the\nhigh danger level") +
  geom_line(data=dfFRP, aes(x=1:dim(dfFRP)[1], y=frp), linetype = 2, col="#47494c") +
  scale_color_manual("Fire radiative power", 
                     values=c("gray", "#47494c"), 
                     labels="Fire radiative power", 
                     guide=guide_legend(direction="vertical", 
                                        title.position="top", 
                                        override.aes=list(shape = "A"))) +
  theme_bw() + labs(x = "Observation date", y = "Forecast date") + 
  scale_x_continuous(expand = c(0, 0), 
                     breaks = 1:dim(dfFRP)[1], 
                     labels = as.character(ObservationDates)) +
  theme(axis.text.x = element_text(angle = 90), 
        panel.grid.major = element_blank(), legend.position = c(.08, .85)) +
  scale_y_continuous(expand = c(0, 0), 
                     breaks = 1:dim(dfFRP)[1], 
                     labels = as.character(ForecastDates),
                     sec.axis = sec_axis(~., 
                                         name = "Fire radiative power [Wm-2]", 
                                         breaks = 1:dim(dfFRP)[1],
                                         labels = round(plotrix::rescale(rangeIDX,
                                                                         c(min(frpTS), 
                                                                           max(frpTS))),0)[1:dim(dfFRP)[1]])) + ggtitle("Canada") + theme(plot.title = element_text(hjust = 0.5))

# ggsave(file="/scratch/mo/moc0/fire/CanadaFRP.eps")
```

#### Spain

Numerous wildfire in Spain were reported in August-September 2016. In the table below we compare the danger levels at large scale and national level.

```{r, eval = TRUE, echo = FALSE}
knitr::kable(df[c(3,4),], row.names = FALSE)
```

```{r, eval = TRUE, fig.height=10, fig.width=10}
# 2. Load the frp file as RasterBrick:
startDate <- "2016-08-19"
endDate <- "2016-09-18"
x <- raster::brick(paste0("/scratch/mo/moc0/fire/events/CAMS_",
                          startDate, "_", endDate, "_frpfire_rotated.nc"))

# 3. Sum all the FRP over time
xsum <- raster::calc(x, sum)

# 4. Convert layer info to binary: 1 if FRP > 0.5, 0 otherwise
xsum[xsum > 0.5] <- 1
xsum[xsum <= 0.5] <- 0
raster::plot(maskcropsub(r = xsum, p = Spain, mask = TRUE, crop = TRUE))

# 5-6. Remove zeros and create a bounding box including only cells = 1
xsum[xsum == 0] <- NA
fireBBOX <- as(raster::extent(raster::trim(maskcropsub(r = xsum, 
                                                       p = Spain, 
                                                       mask = TRUE, 
                                                       crop = TRUE))), 
               'SpatialPolygons')
raster::plot(fireBBOX, border = "red", add = TRUE)
```

In the figure above Spain is shaded in gray while the areas in green show the most important fire activities(fireBBOX), which we compare below with the high danger level calculated previously for Spain.

```{r, eval = TRUE, fig.height=10, fig.width=10}
# Choose the area of interest
areaOfInterest <- fireBBOX

# Modify script to get forecasts /home/mo/moc0/Repositories/fire_utilities/sh/GEFF_Forecast.sh
# Download forecasted FWI
# sh /home/mo/moc0/Repositories/fire_utilities/sh/GEFF_Forecast.sh
# Set forecast and observation dates
ForecastDates <- ObservationDates <- seq.Date(from = as.Date(startDate), 
                                              to = as.Date(endDate),
                                              by = "day")

thresholds <- c(as.numeric(as.character(as.matrix(df[df$Area ==
                                                       "Spain",2:7]))), 100)

# Initialise the matrix to hold the values
rastMean <- matrix(NA, 
                   nrow = length(ObservationDates), 
                   ncol = length(ForecastDates))

# For each starting date and forecast date, calculate average the percentage of
# pixels exceeding the high danger level
for (i in 1:length(ObservationDates)){
  
  # transform dates to strings to build file name
  startD <- gsub("-", "", as.character(ObservationDates[i]))
  
  for (j in 1:length(ForecastDates)){
    
    # transform dates to strings to build file name
    endD <- gsub("-", "", as.character(ForecastDates[j]))
    
    file2read <- paste0("/scratch/mo/moc0/fire/GEFF1.2/forecast_fwi/", 
                        startD, "_", endD, "_ecfire_fwi_fwi.nc")
    
    if (file.exists(file2read)){
      
      rasterMap <- raster::raster(file2read)
      if (round(rasterMap@extent@xmin,0) == 0) rasterMap <- raster::rotate(rasterMap)
      rM <- raster::crop(rasterMap, areaOfInterest)
      nTotal <- dim(rM)[1]*dim(rM)[2]
      perc <- length(rM[rM >= thresholds[4]])/nTotal
      rastMean[i,j] <- perc
      
    }
    
  }
  
}
x <- reshape2::melt(rastMean*100)

# Get FRP
rangeIDX <- 1:length(ForecastDates)
frp <- raster::brick(paste0("/scratch/mo/moc0/fire/events/CAMS_", ObservationDates[1],
                            "_", ObservationDates[length(ObservationDates)],
                            "_frpfire_rotated.nc"))
frpCROPPED <- maskcropsub(r = frp, p = areaOfInterest, 
                          mask = TRUE, crop = FALSE, i2subset = rangeIDX)
frpTS <- as.numeric(raster::cellStats(frpCROPPED, sum))
dfFRP <- data.frame(date = ForecastDates, 
                    frp = plotrix::rescale(frpTS, c(0, length(rangeIDX))))

# Make the boxy forecast plot using ggplot2
ggplot(x, aes(Var1, Var2)) + 
  geom_tile(aes(fill = value), colour = "white") + 
  scale_fill_distiller(palette = "Spectral", na.value = NA,
                       name = "% of pixels\nexceeding the\nhigh danger level") +
  geom_line(data=dfFRP, aes(x=1:dim(dfFRP)[1], y=frp), linetype = 2, col="#47494c") +
  scale_color_manual("Fire radiative power", 
                     values=c("gray", "#47494c"), 
                     labels="Fire radiative power", 
                     guide=guide_legend(direction="vertical", 
                                        title.position="top", 
                                        override.aes=list(shape = "A"))) +
  theme_bw() + labs(x = "Observation date", y = "Forecast date") + 
  scale_x_continuous(expand = c(0, 0), 
                     breaks = 1:dim(dfFRP)[1], 
                     labels = as.character(ObservationDates)) +
  theme(axis.text.x = element_text(angle = 90), 
        panel.grid.major = element_blank(), legend.position = c(.08, .85)) +
  scale_y_continuous(expand = c(0, 0), 
                     breaks = 1:dim(dfFRP)[1], 
                     labels = as.character(ForecastDates),
                     sec.axis = sec_axis(~., 
                                         name = "Fire radiative power [Wm-2]", 
                                         breaks = 1:dim(dfFRP)[1],
                                         labels = round(plotrix::rescale(rangeIDX,
                                                                         c(min(frpTS), 
                                                                           max(frpTS))),0)[1:dim(dfFRP)[1]])) + ggtitle("Spain") + theme(plot.title = element_text(hjust = 0.5))

# ggsave(file="/scratch/mo/moc0/fire/SpainFRP.eps")
```

#### Indonesia

Numerous wildfire in Indonesia were reported from August to October 2015, but we will only look at September 2015 here. In the table below we compare the danger levels at large scale and national level.

```{r, eval = TRUE, echo = FALSE}
knitr::kable(df[c(7,8),], row.names = FALSE)
```

```{r, eval = TRUE, fig.height=10, fig.width=10}
# 2. Load the frp file as RasterBrick:
startDate <- "2015-09-01"
endDate <- "2015-09-30"
x <- raster::brick(paste0("/scratch/mo/moc0/fire/events/CAMS_",
                          startDate, "_", endDate, "_frpfire_rotated.nc"))

# 3. Sum all the FRP over time
xsum <- raster::calc(x, sum)

# 4. Convert layer info to binary: 1 if FRP > 0.5, 0 otherwise
xsum[xsum > 0.5] <- 1
xsum[xsum <= 0.5] <- 0
raster::plot(maskcropsub(r = xsum, p = Indonesia, mask = TRUE, crop = TRUE))

# 5-6. Remove zeros and create a bounding box including only cells = 1
xsum[xsum == 0] <- NA
fireBBOX <- as(raster::extent(raster::trim(maskcropsub(r = xsum, 
                                                       p = Indonesia, 
                                                       mask = TRUE, 
                                                       crop = TRUE))), 
               'SpatialPolygons')
raster::plot(fireBBOX, border = "red", add = TRUE)
```

In the figure above Indonesia is shaded in gray while the areas in green show the most important fire activities(fireBBOX), which we compare below with the high danger level calculated previously for Indonesia.

```{r, eval = TRUE, fig.height=10, fig.width=10}
# Choose the area of interest
areaOfInterest <- fireBBOX

# Modify script to get forecasts /home/mo/moc0/Repositories/fire_utilities/sh/GEFF_Forecast.sh
# Download forecasted FWI
# sh /home/mo/moc0/Repositories/fire_utilities/sh/GEFF_Forecast.sh
# Set forecast and observation dates
ForecastDates <- ObservationDates <- seq.Date(from = as.Date(startDate), 
                                              to = as.Date(endDate),
                                              by = "day")

thresholds <- c(as.numeric(as.character(as.matrix(df[df$Area ==
                                                       "Indonesia",2:7]))), 100)

# Initialise the matrix to hold the values
rastMean <- matrix(NA, 
                   nrow = length(ObservationDates), 
                   ncol = length(ForecastDates))

# For each starting date and forecast date, calculate average the percentage of
# pixels exceeding the high danger level
for (i in 1:length(ObservationDates)){
  
  # transform dates to strings to build file name
  startD <- gsub("-", "", as.character(ObservationDates[i]))
  
  for (j in 1:length(ForecastDates)){
    
    # transform dates to strings to build file name
    endD <- gsub("-", "", as.character(ForecastDates[j]))
    
    file2read <- paste0("/scratch/mo/moc0/fire/GEFF1.2/forecast_fwi/", 
                        startD, "_", endD, "_ecfire_fwi_fwi.nc")
    
    if (file.exists(file2read)){
      
      rasterMap <- raster::raster(file2read)
      if (round(rasterMap@extent@xmin,0) == 0) rasterMap <- raster::rotate(rasterMap)
      rM <- raster::crop(rasterMap, areaOfInterest)
      nTotal <- dim(rM)[1]*dim(rM)[2]
      perc <- length(rM[rM >= thresholds[4]])/nTotal
      rastMean[i,j] <- perc
      
    }
    
  }
  
}
x <- reshape2::melt(rastMean*100)

# Get FRP
rangeIDX <- 1:length(ForecastDates)
frp <- raster::brick(paste0("/scratch/mo/moc0/fire/events/CAMS_", ObservationDates[1],
                            "_", ObservationDates[length(ObservationDates)],
                            "_frpfire_rotated.nc"))
frpCROPPED <- maskcropsub(r = frp, p = areaOfInterest, 
                          mask = TRUE, crop = FALSE, i2subset = rangeIDX)
frpTS <- as.numeric(raster::cellStats(frpCROPPED, sum))
dfFRP <- data.frame(date = ForecastDates, 
                    frp = plotrix::rescale(frpTS, c(0, length(rangeIDX))))

# Make the boxy forecast plot using ggplot2
ggplot(x, aes(Var1, Var2)) + 
  geom_tile(aes(fill = value), colour = "white") + 
  scale_fill_distiller(palette = "Spectral", na.value = NA,
                       name = "% of pixels\nexceeding the\nhigh danger level") +
  geom_line(data=dfFRP, aes(x=1:dim(dfFRP)[1], y=frp), linetype = 2, col="#47494c") +
  scale_color_manual("Fire radiative power", 
                     values=c("gray", "#47494c"), 
                     labels="Fire radiative power", 
                     guide=guide_legend(direction="vertical", 
                                        title.position="top", 
                                        override.aes=list(shape = "A"))) +
  theme_bw() + labs(x = "Observation date", y = "Forecast date") + 
  scale_x_continuous(expand = c(0, 0), 
                     breaks = 1:dim(dfFRP)[1], 
                     labels = as.character(ObservationDates)) +
  theme(axis.text.x = element_text(angle = 90), 
        panel.grid.major = element_blank(), legend.position = c(.08, .85)) +
  scale_y_continuous(expand = c(0, 0), 
                     breaks = 1:dim(dfFRP)[1], 
                     labels = as.character(ForecastDates),
                     sec.axis = sec_axis(~., 
                                         name = "Fire radiative power [Wm-2]", 
                                         breaks = 1:dim(dfFRP)[1],
                                         labels = round(plotrix::rescale(rangeIDX,
                                                                         c(min(frpTS), 
                                                                           max(frpTS))),0)[1:dim(dfFRP)[1]])) + ggtitle("Indonesia") + theme(plot.title = element_text(hjust = 0.5))

# ggsave(file="/scratch/mo/moc0/fire/IndonesiaFRP.eps")
```

#### Chile

Numerous wildfire in Chile were reported in January 2017. In the table below we compare the danger levels at large scale and national level.

```{r, eval = TRUE, echo = FALSE}
knitr::kable(df[c(7,8),], row.names = FALSE)
```

```{r, eval = TRUE, fig.height=10, fig.width=10}
# 2. Load the frp file as RasterBrick:
startDate <- "2017-01-01"
endDate <- "2017-01-31"
x <- raster::brick(paste0("/scratch/mo/moc0/fire/events/CAMS_",
                          startDate, "_", endDate, "_frpfire_rotated.nc"))

# 3. Sum all the FRP over time
xsum <- raster::calc(x, sum)

# 4. Convert layer info to binary: 1 if FRP > 0.5, 0 otherwise
xsum[xsum > 0.5] <- 1
xsum[xsum <= 0.5] <- 0 # extra step to plot pixels <= 0.5 as gray background
raster::plot(maskcropsub(r = xsum, p = Chile, mask = TRUE, crop = TRUE))

# 5-6. Remove zeros and create a bounding box including only cells = 1
xsum[xsum == 0] <- NA
fireBBOX <- as(raster::extent(raster::trim(maskcropsub(r = xsum, 
                                                       p = Chile, 
                                                       mask = TRUE, 
                                                       crop = TRUE))), 
               'SpatialPolygons')
raster::plot(fireBBOX, border = "red", add = TRUE)
```

In the figure above Chile is shaded in gray while the areas in green show the most important fire activities(fireBBOX), which we compare below with the high danger level calculated previously for Chile.

```{r, eval = TRUE, fig.height=10, fig.width=10}
plotOBSvsForecast(inDir = "/scratch/mo/moc0/fire/GEFF1.2/forecast_fwi", 
                  areaOfInterest = fireBBOX, 
                  threshold = df$High[df$Area == "Chile"], 
                  startDate = "2017-01-01", endDate = "2017-01-31",
                  obsFilePath = "/scratch/mo/moc0/fire/events/CAMS_2017-01-01_2017-01-31_frpfire_rotated.nc")
# ggsave(file="/scratch/mo/moc0/fire/ChileFRP.eps")
```
